#include <stdio.h>
#include <assert.h>
#include "thread.h"

unsigned long cpt;

struct tableau {

    int * tab;
    int taille;
    int debut;
};

int* init_tab (int * tab, int taille);
static void * tri(void *_value);

int main(int argc, char *argv[])
{
  unsigned long value, res;
  cpt = 0;
 
  if (argc < 2) {
    printf("argument manquant: entier x pour lequel calculer tri(x)\n");
    return -1;
  }
  
  value = atoi(argv[1]);

  res = (unsigned long) tri((void *)value);
  printf("tri de %ld = %ld\n", value, cpt + 1);

  return 0;
}

int* init_tab (int * tab, int taille) 
{
  int i;
  tab = malloc (taille * sizeof (int));
  
  srand(time(NULL));
  for (i=0; i<taille; i++)
  {
    tab[i] = (int)(unsigned char) rand();
  }

  return tab;
}

static void * tri(void *_value)
{
  struct thread_t th, th2;
  int err;
  void *res = NULL, *res2 = NULL;
  unsigned long value = (unsigned long) _value;

  if (value == 1)
    return (void*) 1;

  struct tableau *tab = malloc (sizeof (struct tableau)); 
  if (tab == NULL) return 1;
  
  tab->taille = value;
  tab->debut = 0;
  tab->tab = init_tab (tab->tab, tab->taille);
  

  struct tableau *tab1 = (struct tableau*) malloc (sizeof (struct tableau)); 
  struct tableau *tab2 = (struct tableau*) malloc (sizeof (struct tableau)); 

  tab1->tab = tab->tab;
  tab2->tab = tab->tab;
  unsigned long taille1 = tab1->taille = (int) (tab->taille/2);
  unsigned long taille2 = tab2->taille = (int) (tab->taille - taille1);
 
  tab1->debut = tab->debut;
  tab2->debut = tab->debut+taille1;

  //printf("Taille 1 et Taille 2 est %d et %d\n", taille1, taille2);

  err = thread_create(&th, tri, (void*)(taille1));
  assert(!err);
  err = thread_create(&th2, tri, (void*)(taille2));
  assert(!err);

  err = thread_join(&th, &res);
  assert(!err);
  err = thread_join(&th2, &res2);
  assert(!err);

  cpt += 2;
  return (void*)((unsigned long) res + (unsigned long) res2);
}
