#include "spinlock.h"
#define X86_32
#if defined X86_32
#define SPINLOCK_UNLOCKED { 1 }

int thread_spin_init(struct thread_spinlock_t * lock, int pshared){
    /* We can ignore the `pshared' parameter.  Since we are busy-waiting
       all processes which can access the memory location `lock' points
       to can use the spinlock.  */
  lock = 0;
  return 0;
}
int thread_spin_unlock(struct thread_spinlock_t * lock)
{
  char oldval;
  __asm__ __volatile__("movb $1,%0"
		       : "=m" (lock->lock) : : "memory");
  return oldval >0;
}
int thread_spin_trylock(struct thread_spinlock_t * lock)
{
  char oldval;
  __asm__ __volatile__("xchgb %b0,%1":"=q"(oldval),
		       "=m"(lock->lock)
		       : "0"(0) : "memory");
  return oldval > 0;
}

int thread_spin_lock(struct thread_spinlock_t * lock)
{
  char oldval;
  __asm__ __volatile__("\n1:\t"
		       "lock ; decb %0\n\t"
		       "jns 3f\n"
		       "2:\t"
		       "rep;nop\n\t"
		       "cmpb $0,%0\n\t"
		       "jle 2b\n\t"
		       "jmp 1b\n\t"
		       "3:\n" : "=m"(lock->lock) : : "memory");
  
  return oldval > 0; 
}

int thread_spin_destroy(struct thread_spinlock_t * lock){
  /*nothing*/
  return 0;
}


#elif defined X86_64
#else
#error Neither X86_64 nor X86_32 is defined
#endif
