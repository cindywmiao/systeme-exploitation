#include "fifo.h"

struct element* create_element( struct thread_t* t) {
  struct element* elm = malloc(sizeof(struct element));
  if(elm) {
    elm->data = t;
    elm->next = NULL;
    elm->prev = NULL;
    return elm;
  }
  return NULL;
}

void free_element(struct element* elm) {
  assert(elm){
    free(elm->data->uc->uc_stack.ss_sp);
    free(elm->data->uc->uc_link);
    free(elm->data->uc);
    free(elm->data);
    free(elm);
  }
}

int fifo_isempty(struct thread_fifo* f) {
  assert(f);
  if(f->head)
    return 0;
  return 1;
}

struct thread_fifo* fifo_create() {
  struct fifo* f = malloc(sizeof(struct thread_fifo));
  if(f) {
    f->head = NULL;
    f->tail = NULL;
    f->size = 0;
    return f;
  }
  return NULL;
  }

void fifo_free(struct thread_fifo* f) {
  assert(f);
  struct element* elm = f->head;
  while(elm) {
    struct element* tmp = elm;
    elm = elm->next;   
    free_element(tmp);
  }
}

void fifo_kill(struct thread_fifo* f){
  fifo_free(f);    
  free(f);
}

struct thread_t* fifo_gethead(struct thread_fifo* f) {
  assert(f->head);
  return f->head->data;
}

struct thread_t* fifo_findthread (int id) {
  if(!f)
    return NULL;
  struct element* elm = f->head;
  while(elm){
    if (elm->data->id == id) 
      return elm->data;
  }
  return NULL;
}

void fifo_addthread(struct thread_fifo* f, struct thread_t* t) {
  assert(f && t);
  struct element* elm = create_element(t);
  if(fifo->head) {
    struct element* tmp = fifo->tail;
    tmp->next = elm;
    elm->prev = tmp;
    f->tail = elm;
  }
  else {
    f->head = elm;
    f->tail = elm;
  }
}

void fifo_remove_element(struct thread_fifo* f, struct element* elm) {
  if (elm->prev)
    elm->prev->next = elm->next;
  else
    f->head = elm->next;
  if(elm->next)
    elm->next->prev = elm->prev;
  else {
    if (elm->prev)
      elm->prev->next = NULL;
    f->tail = elm->prev;
  }
}

void fifo_remove_head(struct thread_fifo* f) {
  assert(f->head);
  struct element* tmp = f->head;
  if(tmp && tmp->next){
    f->head = tmp->next;
    f->head->prev = NULL;
  }
  else {
    f->head = NULL;
    f->tail = NULL;
  }
  free(tmp);
}

void fifo_remove_thread (struct thread_fifo* f, int id) {
  assert(f);
  struct element* elm = f->head;
  while(elm) {
    if(elm->data->id == if)
      fifo_remove_element(f,elm);
    elm = elm->next;
  }
  free(elm);
}



