#include <stdio.h>
#include <stdlib.h>
#include <ucontext.h> /* ne compile pas avec -std=c89 ou -std=c99 */
ucontext_t uc[2];

int yield(int n) {
  swapcontext(&uc[n],&uc[1-n]);
}


void func(int numero)
{
  int i;
  for(i = 0; i < 100; i++){
    printf("%d : j'affiche le numéro %d\n",i, numero);
    yield (1-numero);
  }
}

int main() {
  

  getcontext(&uc[0]); /* initialisation de uc avec valeurs coherentes
		    * (pour éviter de tout remplit a la main ci-dessous) */
  getcontext(&uc[1]);

  int i;

  uc[1].uc_stack.ss_size = 64*1024;
  uc[1].uc_stack.ss_sp = malloc(uc[1].uc_stack.ss_size);
  uc[1].uc_link = NULL;
  makecontext(&uc[1], (void(*)(void)) func, 1, 0);

  uc[0].uc_stack.ss_size = 64*1024;
  uc[0].uc_stack.ss_sp = malloc(uc[0].uc_stack.ss_size);
  //uc.uc_link = &uc[1];
  uc[0].uc_link = NULL;
  makecontext(&uc[0], (void (*)(void)) func, 1, 1);

  setcontext(&uc[0]);

  printf("je ne reviens jamais ici\n");
  return 0;
}
