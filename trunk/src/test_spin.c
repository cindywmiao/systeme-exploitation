#include <stdio.h>
#include <stdlib.h>
#include <assert.h>
#include <sys/time.h>
#include <signal.h>
#include <string.h>

#include "spinlock.h"
#include "thread.h"


struct thread_spinlock_t *mutex;

void timer_handler() {
    printf("timer handler (1sec)\n");
    thread_yield();
}

static void * threadfunc(void * arg)
{
    /* struct sigaction sa; */
    /* memset (&sa, 0, sizeof (sa));  */
    /* sa.sa_handler = &timer_handler;  */
    /* sigaction (SIGVTALRM, &sa, NULL);  */

    /* struct itimerval *value = malloc(sizeof(struct itimerval)); */
    /* value->it_interval.tv_sec = 1; */
    /* value->it_value.tv_sec = 1; */
    /* setitimer (ITIMER_VIRTUAL, value, NULL); */

    char *name = arg;

    thread_spin_lock (mutex);

    int i;
    for (i=0; i<1000000000; i++) { // 10 sec
        if (i%100000000 == 0) { // 1 sec
            printf("%s\n", name);
        }
    }
    
    thread_spin_unlock (mutex);    
}

int main(void)
{
    struct thread_t thread1, thread2;
    void *retval1, *retval2;
    int err;

    mutex = malloc (sizeof(struct thread_spinlock_t));
    mutex->lock = 1;

    lib_init();

    err = thread_create(&thread1, threadfunc, "thread1");
    assert(!err);
    err = thread_create(&thread2, threadfunc, "thread2");
    assert(!err);

    err = thread_join(&thread2, &retval2);
    assert(!err);
    err = thread_join(&thread1, &retval1);
    assert(!err);

    return EXIT_SUCCESS;
}
