#include "fifoprio.h"

struct element* create_element( struct thread_t* t) {
  struct element* elm = malloc(sizeof(struct element));
  if(elm) {
    elm->data = t;
    elm->next = NULL;
    elm->prev = NULL;
    return elm;
  }
  return NULL;
}

void free_element(struct element* elm) {
  assert(elm);
  free(elm->data->uc->uc_stack.ss_sp);
  free(elm->data->uc->uc_link);
  free(elm->data->uc);
  free(elm->data);
  free(elm);

}

int fifo_isempty(struct fifo* f) {
  assert(f);
  if(f->head)
    return 0;
  return 1;
}

struct fifo* fifo_create() {
  struct fifo* f = malloc(sizeof(struct fifo));
  if(f) {
    f->head = NULL;
    f->tail = NULL;
    f->size = 0;
    return f;
  }
  return NULL;
}

void fifo_free(struct fifo* f) {
  assert(f);
  struct element* elm = f->head;
  while(elm) {
    struct element* tmp = elm;
    elm = elm->next;   
    free_element(tmp);
  }
}

void fifo_kill(struct fifo* f){
  fifo_free(f);    
  free(f);
}

struct thread_t* fifo_gethead(struct fifo* f) {
  assert(f->head);
  return f->head->data;
}

struct thread_t* fifo_findthread (struct fifo* f, int id) {
  if(!f)
    return NULL;
  struct element* elm = f->head;
  while(elm){
    if (elm->data->id == id) 
      return elm->data;
    elm= elm->next;
  }
  return NULL;
}





void fifo_remove_element(struct fifo* f, struct element* elm) {
  if (elm->prev)
    elm->prev->next = elm->next;
  else
    f->head = elm->next;
  if(elm->next)
    elm->next->prev = elm->prev;
  else {
    if (elm->prev)
      elm->prev->next = NULL;
    f->tail = elm->prev;
  }
  f->size--;
}

struct thread_t* fifo_remove_head(struct fifo* f) {
  assert(f->head);
  struct element* tmp = f->head;
  struct thread_t* data = tmp->data;
  if(tmp && tmp->next){
    f->head = tmp->next;
    f->head->prev = NULL;
    f->size--;
  }
  else {
    f->head = NULL;
    f->tail = NULL;
    f->size = 0;
  }
  free(tmp);
  return data;
}

void fifo_remove_thread (struct fifo* f, int id) {
  assert(f);
  struct element* elm = f->head;
  while(elm) {
    if(elm->data->id == id)
      fifo_remove_element(f,elm);
    elm = elm->next;
  }
  free(elm);
}


void fifo_addhead(struct fifo* f, struct thread_t *t){

  printf("add head\n");
  assert((f!=NULL) && (t != NULL));
  struct element* elm = create_element(t);
  if(f->head) {
    struct element* tmp = f->head;
    tmp->prev = elm;
    elm->next = tmp;
    f->head = elm;
  }
  else {
    f->head = elm;
    f->tail = elm;
  }
  f->size++;
}

void fifo_addthreadprio(struct fifo *f, struct thread_t *t){

  assert(f!= NULL && t!= NULL);
  struct element *elm = create_element(t);
  unsigned int i = 0;
  
  if(f->head){
    struct element * tmp= f->head;
   

    while(tmp != NULL && i <= f->size){
      i++;
      struct thread_t* data = tmp->data;
      if(data->priorite >= t->priorite){
	tmp->prev = elm;
	elm->next = tmp;
	if(i ==1)
	  f->head = elm;
	
	break;
      }
      else{
	
	tmp->next = elm;
	elm->prev = tmp;
	elm->next = tmp->next;
	(tmp->next)->prev = elm;
	/* elm->prev = tmp; */
	/* elm->next = tmp->next; */
	/* tmp = tmp->next; */
	
      }
      tmp = tmp->next;
    }
    
  }
  else{
    f->head = elm;
    f->tail = elm;
  }

  f->size++;
}
/* void fifo_addthread(struct fifo* f, struct thread_t* t) { */
/*   assert((f!=NULL) && (t != NULL)); */
/*   struct element* elm = create_element(t); */
/*   /\* if(f->head) { *\/ */
/*   /\*   struct element* tmp = f->tail; *\/ */
/*   /\*   tmp->next = elm; *\/ */
/*   /\*   elm->prev = tmp; *\/ */
/*   /\*   f->tail = elm; *\/ */
/*   /\* } *\/ */
/*   /\* else { *\/ */
/*   /\*   f->head = elm; *\/ */
/*   /\*   f->tail = elm; *\/ */
/*   /\* } *\/ */
/*   f->size++; */
/* } */
